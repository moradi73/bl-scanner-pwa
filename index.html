<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Escanea y organiza tus Bon de Livraison">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>BL Scanner Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .header { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 600px; margin: 0 auto; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; }
        .header-title h1 { color: #667eea; font-size: 20px; }
        .header-title p { color: #666; font-size: 11px; }
        .status-badge { font-size: 11px; font-weight: bold; padding: 5px 10px; border-radius: 20px; background: #d4edda; color: #155724; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card-title { font-size: 18px; font-weight: bold; color: #2d3748; margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; color: white; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-secondary { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); flex: 2; }
        .btn-warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); flex: 1; }
        .btn-manual { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); }
        input[type="file"] { display: none; }
        .preview-img { width: 100%; border-radius: 12px; margin: 15px 0; max-height: 400px; object-fit: contain; }
        .loading { background: linear-gradient(135deg, #ebf4ff 0%, #e0e7ff 100%); border-radius: 12px; padding: 20px; margin: 15px 0; text-align: center; }
        .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-text { color: #667eea; font-weight: bold; font-size: 14px; margin-top: 10px; }
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; }
        .error-box { background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); border: 2px solid #fc8181; border-radius: 12px; padding: 15px; margin: 15px 0; }
        .error-box h3 { color: #c53030; margin-bottom: 10px; font-size: 16px; }
        .error-box p { color: #742a2a; font-size: 14px; line-height: 1.5; margin-bottom: 10px; }
        .data-box { background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border: 2px solid #48bb78; border-radius: 15px; padding: 20px; margin: 15px 0; }
        .data-box-header { text-align: center; margin-bottom: 15px; }
        .data-row { background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .data-label { font-weight: bold; color: #2d3748; font-size: 14px; }
        .data-value { color: #4a5568; text-align: right; max-width: 60%; word-break: break-word; font-size: 14px; }
        .pdf-name-box { background: white; border: 2px dashed #667eea; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .pdf-name-box p { color: #667eea; font-family: monospace; font-size: 12px; word-break: break-all; line-height: 1.4; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        .folder-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 10px; font-size: 14px; font-weight: bold; margin-bottom: 15px; display: inline-block; }
        .doc-item { background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-left: 4px solid #667eea; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        .doc-name { font-weight: bold; font-size: 13px; color: #2d3748; margin-bottom: 8px; word-break: break-all; line-height: 1.3; }
        .doc-date { font-size: 12px; color: #718096; margin-bottom: 12px; }
        .doc-actions { display: flex; gap: 8px; }
        .doc-actions button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 13px; font-weight: bold; cursor: pointer; }
        .doc-download { background: #667eea; color: white; }
        .doc-delete { background: #f56565; color: white; flex: 0 0 auto; padding: 12px 15px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #a0aec0; }
        .info-box { background: linear-gradient(135deg, #ebf4ff 0%, #e0e7ff 100%); border: 2px solid #667eea; border-radius: 12px; padding: 15px; font-size: 13px; }
        .info-box ul { list-style: none; padding: 0; }
        .info-box li { padding: 6px 0; display: flex; gap: 8px; align-items: start; }
        .tip-box { background: linear-gradient(135deg, #fef5e7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 12px; margin: 10px 0; font-size: 13px; color: #92400e; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>üìÑ BL Scanner Pro</h1>
                <p>Bon de Livraison PWA</p>
            </div>
            <div id="statusBadge" class="status-badge">üü¢ Online</div>
        </div>
    </div>
    <div class="container">
        <div class="card">
            <div class="card-title">üì∏ Escanear Documento</div>
            <button class="btn btn-primary" onclick="document.getElementById('camera').click()">üì∑ Tomar Foto con C√°mara</button>
            <button class="btn btn-secondary" onclick="document.getElementById('file').click()">üñºÔ∏è Seleccionar de Galer√≠a</button>
            <button class="btn btn-manual" onclick="showManualEntry()" style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);">‚úèÔ∏è Entrada Manual (Sin OCR)</button>
            <input type="file" id="camera" accept="image/*" capture="environment" onchange="handleImage(this)">
            <input type="file" id="file" accept="image/*" onchange="handleImage(this)">
            <div class="tip-box">
                üí° <strong>Consejo:</strong> Para mejor OCR: buena luz, enfoque claro, documento completo visible.
            </div>
            <div id="preview"></div>
            <div id="loading" style="display:none;" class="loading">
                <div class="spinner"></div>
                <div class="progress-text" id="progressText">Procesando imagen...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            <div id="error"></div>
            <div id="result"></div>
        </div>
        <div class="card">
            <div class="card-title">üìÅ Documentos Guardados</div>
            <div class="folder-badge">üìÇ BL.MTR 2025</div>
            <div id="documentsCount" style="font-size: 14px; color: #666; margin-bottom: 15px;"></div>
            <div id="documents"></div>
        </div>
        <div class="card">
            <div class="card-title">‚ÑπÔ∏è Informaci√≥n</div>
            <div class="info-box">
                <ul>
                    <li><span>‚úÖ</span> <span>OCR autom√°tico en franc√©s</span></li>
                    <li><span>‚úÖ</span> <span>Entrada manual disponible</span></li>
                    <li><span>‚úÖ</span> <span>Funciona sin conexi√≥n</span></li>
                    <li><span>‚úÖ</span> <span>Genera PDFs profesionales</span></li>
                    <li><span>‚úÖ</span> <span>Organiza en BL.MTR 2025</span></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let currentImageData = null;
        let extractedData = null;
        let documents = [];
        let ocrWorker = null;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .catch(e => console.log('Error SW:', e));
            });
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        function updateOnlineStatus() {
            const badge = document.getElementById('statusBadge');
            if (navigator.onLine) {
                badge.style.background = '#d4edda';
                badge.style.color = '#155724';
                badge.textContent = 'üü¢ Online';
            } else {
                badge.style.background = '#f8d7da';
                badge.style.color = '#721c24';
                badge.textContent = 'üî¥ Offline';
            }
        }

        function loadDocuments() {
            const saved = localStorage.getItem('bl_documents');
            if (saved) {
                try {
                    documents = JSON.parse(saved);
                } catch (e) {
                    documents = [];
                }
            }
            renderDocuments();
        }

        function saveDocuments() {
            try {
                localStorage.setItem('bl_documents', JSON.stringify(documents));
            } catch (e) {
                alert('‚ö†Ô∏è Error al guardar');
            }
        }

        function handleImage(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('error').innerHTML = '';
            document.getElementById('result').innerHTML = '';

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                document.getElementById('preview').innerHTML = 
                    '<img src="' + e.target.result + '" class="preview-img" alt="Preview">';
                
                // Mostrar opciones
                const options = '<div style="margin-top:15px;">' +
                    '<button class="btn btn-success" onclick="processImageWithOCR()">ü§ñ Extraer con OCR</button>' +
                    '<button class="btn btn-manual" onclick="showManualEntry()">‚úèÔ∏è Ingresar Manualmente</button>' +
                    '</div>';
                document.getElementById('preview').innerHTML += options;
            };
            reader.onerror = function() {
                showError('Error al leer la imagen', 'No se pudo cargar. Intenta de nuevo.');
            };
            reader.readAsDataURL(file);
        }

        async function processImageWithOCR() {
            if (!currentImageData) {
                alert('‚ö†Ô∏è Primero toma una foto');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').innerHTML = '';
            document.getElementById('error').innerHTML = '';
            document.getElementById('progressFill').style.width = '0%';
            
            try {
                updateProgress('Verificando conexi√≥n...', 5);

                if (!navigator.onLine) {
                    throw new Error('Sin conexi√≥n a internet. El OCR necesita internet la primera vez.');
                }

                updateProgress('Inicializando OCR...', 10);

                ocrWorker = await Tesseract.createWorker('fra', 1, {
                    logger: m => {
                        console.log(m);
                        if (m.status === 'recognizing text') {
                            const percent = 10 + Math.round(m.progress * 80);
                            updateProgress('Extrayendo texto... ' + Math.round(m.progress * 100) + '%', percent);
                        } else if (m.status === 'loading tesseract core') {
                            updateProgress('Descargando OCR (solo primera vez)...', 15);
                        } else if (m.status === 'initializing tesseract') {
                            updateProgress('Preparando OCR...', 20);
                        } else if (m.status === 'loading language traineddata') {
                            updateProgress('Descargando idioma franc√©s...', 25);
                        } else if (m.status === 'initializing api') {
                            updateProgress('Inicializando motor...', 30);
                        }
                    },
                    errorHandler: err => {
                        console.error('OCR Error:', err);
                    }
                });

                updateProgress('Procesando imagen...', 90);

                const { data: { text, confidence } } = await ocrWorker.recognize(currentImageData);
                
                console.log('Texto extra√≠do:', text);
                console.log('Confianza:', confidence);

                await ocrWorker.terminate();
                ocrWorker = null;

                updateProgress('¬°Completado!', 100);

                if (!text || text.trim().length < 10) {
                    throw new Error('No se extrajo suficiente texto. La imagen puede estar borrosa o muy oscura.');
                }

                extractedData = extractBLData(text);
                document.getElementById('loading').style.display = 'none';
                displayExtractedData(confidence);
                
            } catch (error) {
                console.error('Error completo:', error);
                document.getElementById('loading').style.display = 'none';
                
                if (ocrWorker) {
                    try { await ocrWorker.terminate(); } catch (e) {}
                    ocrWorker = null;
                }
                
                showError(
                    'Error al procesar imagen',
                    error.message || 'Error desconocido',
                    true
                );
            }
        }

        function updateProgress(text, percent) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function showError(title, message, showManualButton = false) {
            let html = '<div class="error-box">' +
                '<h3>‚ùå ' + title + '</h3>' +
                '<p>' + message + '</p>' +
                '<p style="margin-top:10px;"><strong>Posibles causas:</strong></p>' +
                '<ul style="margin:5px 0 0 20px;font-size:13px;">' +
                '<li>Imagen borrosa o muy oscura</li>' +
                '<li>Texto muy peque√±o</li>' +
                '<li>Documento incompleto en la foto</li>' +
                '<li>Problema de conexi√≥n</li>' +
                '</ul>';
            
            if (showManualButton) {
                html += '<button class="btn btn-manual" onclick="showManualEntry()" style="margin-top:10px;">' +
                    '‚úèÔ∏è Ingresar Datos Manualmente' +
                    '</button>';
            }
            
            html += '</div>';
            document.getElementById('error').innerHTML = html;
        }

        function showManualEntry() {
            document.getElementById('error').innerHTML = '';
            
            const numero = prompt('N√∫mero BL:', '') || Math.floor(Math.random() * 9000000 + 1000000).toString();
            const fecha = prompt('Fecha (DD/MM/YYYY):', new Date().toLocaleDateString('es-ES')) || new Date().toLocaleDateString('es-ES');
            const cliente = prompt('Cliente:', 'GROUPEMENT SGTM') || 'GROUPEMENT SGTM';
            const nCommande = prompt('N¬∞ Commande (opcional):', numero) || numero;

            extractedData = { numero, fecha, cliente, nCommande };
            displayExtractedData(100);
        }

        function extractBLData(text) {
            let numero = '', fecha = '', cliente = '', nCommande = '';
            
            try {
                // Buscar n√∫mero
                const numeroPatterns = [
                    /NOMBRE[:\s]+(\d{7,})/i,
                    /N[¬∞\s]*COMMANDE[:\s]*([A-Z0-9\-]{5,})/i,
                    /(\d{7,})/
                ];
                
                for (let pattern of numeroPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        numero = match[1];
                        break;
                    }
                }
                
                // Buscar fecha
                const fechaPatterns = [
                    /DATE[:\s]+(\d{2}[\/\-]\d{2}[\/\-]\d{4})/i,
                    /(\d{2}[\/\-]\d{2}[\/\-]\d{4})/,
                    /(\d{2}\s+\d{2}\s+\d{4})/
                ];
                
                for (let pattern of fechaPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        fecha = match[1].replace(/[-\s]/g, '/');
                        break;
                    }
                }
                
                // Buscar cliente
                const clientePatterns = [
                    /GROUPEMENT[^\n]{0,50}/i,
                    /SGTM[^\n]{0,50}/i,
                    /DEPOT[^\n]{0,50}/i,
                    /CLIENT[:\s]+([^\n]{5,50})/i
                ];
                
                for (let pattern of clientePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        cliente = (match[1] || match[0]).trim().replace(/\s+/g, ' ').substring(0, 50);
                        break;
                    }
                }
                
                // Buscar N¬∞ Commande
                const commandeMatch = text.match(/COMMANDE[:\s]*([A-Z0-9\-]{4,})/i);
                if (commandeMatch) nCommande = commandeMatch[1];

            } catch (e) {
                console.error('Error extrayendo datos:', e);
            }

            // Valores por defecto
            if (!numero || numero.length < 4) numero = Math.floor(Math.random() * 9000000 + 1000000).toString();
            if (!fecha) fecha = new Date().toLocaleDateString('es-ES');
            if (!cliente || cliente.length < 3) cliente = 'CLIENTE EXTRAIDO';
            if (!nCommande) nCommande = numero;

            return { numero, fecha, cliente, nCommande };
        }

        function displayExtractedData(confidence) {
            const pdfName = generatePDFName(extractedData);
            const confPercent = Math.round(confidence || 0);
            
            let confColor = '#48bb78';
            let confIcon = '‚úÖ';
            if (confPercent < 70) {
                confColor = '#ed8936';
                confIcon = '‚ö†Ô∏è';
            }
            if (confPercent < 50) {
                confColor = '#f56565';
                confIcon = '‚ùå';
            }
            
            document.getElementById('result').innerHTML = 
                '<div class="data-box">' +
                '<div class="data-box-header">' +
                '<span style="font-size: 30px;">' + confIcon + '</span>' +
                '<h3 style="color: #22543d;">Datos Extra√≠dos</h3>' +
                (confPercent > 0 ? '<p style="font-size:12px;color:' + confColor + ';margin-top:5px;">Confianza: ' + confPercent + '%</p>' : '') +
                '</div>' +
                '<div class="data-row"><span class="data-label">N√∫mero BL:</span><span class="data-value">' + extractedData.numero + '</span></div>' +
                '<div class="data-row"><span class="data-label">Fecha:</span><span class="data-value">' + extractedData.fecha + '</span></div>' +
                '<div class="data-row"><span class="data-label">Cliente:</span><span class="data-value">' + extractedData.cliente + '</span></div>' +
                '<div class="data-row"><span class="data-label">N¬∞ Commande:</span><span class="data-value">' + extractedData.nCommande + '</span></div>' +
                '<div class="pdf-name-box"><label style="font-size:12px;font-weight:bold;color:#666;margin-bottom:8px;display:block;">üìÑ Nombre del PDF:</label><p>' + pdfName + '</p></div>' +
                '<div class="button-group">' +
                '<button class="btn btn-warning" onclick="editData()">‚úèÔ∏è Editar</button>' +
                '<button class="btn btn-success" onclick="saveDocument()">üíæ Guardar</button>' +
                '</div></div>';
        }

        function editData() {
            const newNumero = prompt('N√∫mero BL:', extractedData.numero);
            if (!newNumero) return;
            const newFecha = prompt('Fecha (DD/MM/YYYY):', extractedData.fecha);
            if (!newFecha) return;
            const newCliente = prompt('Cliente:', extractedData.cliente);
            if (!newCliente) return;
            const newCommande = prompt('N¬∞ Commande:', extractedData.nCommande);

            extractedData.numero = newNumero;
            extractedData.fecha = newFecha;
            extractedData.cliente = newCliente;
            if (newCommande) extractedData.nCommande = newCommande;
            
            displayExtractedData(0);
        }

        function generatePDFName(data) {
            const fechaFormatted = data.fecha.replace(/\//g, '-');
            const clienteTruncated = data.cliente.substring(0, 30).trim();
            return 'BL.' + data.numero + ' ' + fechaFormatted + ' ' + clienteTruncated + '.pdf';
        }

        function saveDocument() {
            if (!extractedData) {
                alert('‚ö†Ô∏è No hay datos para guardar');
                return;
            }

            try {
                const doc = {
                    id: Date.now(),
                    fileName: generatePDFName(extractedData),
                    data: extractedData,
                    image: currentImageData || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
                    timestamp: new Date().toISOString()
                };

                documents.unshift(doc);
                saveDocuments();
                renderDocuments();
                
                document.getElementById('preview').innerHTML = '';
                document.getElementById('result').innerHTML = '';
                document.getElementById('error').innerHTML = '';
                currentImageData = null;
                extractedData = null;
                
                alert('‚úÖ Documento guardado!\n\nüìÅ BL.MTR 2025/\n' + doc.fileName);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }

        function renderDocuments() {
            const container = document.getElementById('documents');
            const countEl = document.getElementById('documentsCount');
            
            countEl.textContent = 'Total: ' + documents.length + ' documento' + (documents.length !== 1 ? 's' : '');
            
            if (documents.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state">' +
                    '<div style="font-size:50px;opacity:0.3;margin-bottom:15px;">üìÑ</div>' +
                    '<p style="font-size:15px;font-weight:bold;margin-bottom:5px;">No hay documentos</p>' +
                    '<p style="font-size:13px;">Escanea tu primer BL</p>' +
                    '</div>';
                return;
            }

            container.innerHTML = documents.map(doc => 
                '<div class="doc-item">' +
                '<div class="doc-name">üìÑ ' + doc.fileName + '</div>' +
                '<div class="doc-date">' + new Date(doc.timestamp).toLocaleString('es-ES') + '</div>' +
                '<div class="doc-actions">' +
                '<button class="doc-download" onclick="downloadPDF(' + doc.id + ')">‚¨áÔ∏è PDF</button>' +
                '<button class="doc-delete" onclick="deleteDoc(' + doc.id + ')">üóëÔ∏è</button>' +
                '</div></div>'
            ).join('');
        }

        async function downloadPDF(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) return;

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                pdf.setFontSize(16);
                pdf.setTextColor(102, 126, 234);
                pdf.text('Bon de Livraison', 105, 15, { align: 'center' });
                
                if (doc.image && doc.image.length > 100) {
                    try {
                        pdf.addImage(doc.image, 'JPEG', 10, 25, 190, 120);
                    } catch (e) {
                        console.log('No se pudo a√±adir imagen');
                    }
                }
                
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text('Numero BL: ' + doc.data.numero, 15, 155);
                pdf.text('Fecha: ' + doc.data.fecha, 15, 165);
                pdf.text('Cliente: ' + doc.data.cliente, 15, 175);
                pdf.text('N¬∞ Commande: ' + doc.data.nCommande, 15, 185);
                
                pdf.setFontSize(9);
                pdf.setTextColor(128, 128, 128);
                pdf.text('Generado por BL Scanner Pro', 105,